"use strict";
var __assign = (this && this.__assign) || function () {
    __assign = Object.assign || function(t) {
        for (var s, i = 1, n = arguments.length; i < n; i++) {
            s = arguments[i];
            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))
                t[p] = s[p];
        }
        return t;
    };
    return __assign.apply(this, arguments);
};
var __spreadArray = (this && this.__spreadArray) || function (to, from, pack) {
    if (pack || arguments.length === 2) for (var i = 0, l = from.length, ar; i < l; i++) {
        if (ar || !(i in from)) {
            if (!ar) ar = Array.prototype.slice.call(from, 0, i);
            ar[i] = from[i];
        }
    }
    return to.concat(ar || Array.prototype.slice.call(from));
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.graphQlQueryToJson = void 0;
var graphql_1 = require("graphql");
var json_to_graphql_query_1 = require("json-to-graphql-query");
var mapValues = require("lodash.mapvalues");
var undefinedVariableConst = "undefined_variable";
var isVariableDropinConst = "_____isVariableDropinConst";
var flatMap = function (arg, callback) {
    return arg.reduce(function (callbackFn, initialValue) { return callbackFn.concat(callback(initialValue)); }, []);
};
var isString = function (arg) { return typeof arg === "string"; };
var isObject = function (arg) { return arg instanceof Object; };
var getArgumentObject = function (argumentFields) {
    var argObj = {};
    argumentFields.forEach(function (arg) {
        if (arg.value.kind === "ObjectValue") {
            argObj[arg.name.value] = getArgumentObject(arg.value.fields);
        }
        else if (arg.value.kind === "ListValue") {
            argObj[arg.name.value] = arg.value.values;
        }
        else if (arg.value.kind === "IntValue") {
            argObj[arg.name.value] = parseInt(arg.value.value);
        }
        else if (arg.value.kind === "FloatValue") {
            argObj[arg.name.value] = parseFloat(arg.value.value);
        }
        else if (arg.value.kind === "Variable") {
            argObj[arg.name.value] =
                "".concat(arg.value.name.value).concat(isVariableDropinConst);
        }
        else {
            argObj[arg.name.value] = arg.value.value;
        }
    });
    return argObj;
};
var getArguments = function (args) {
    var argsObj = {};
    args.forEach(function (arg) {
        if (arg.value.kind === "ObjectValue") {
            argsObj[arg.name.value] = getArgumentObject(arg.value.fields);
        }
        else if (arg.value.kind === "Variable") {
            argsObj[arg.name.value] =
                "".concat(arg.value.name.value).concat(isVariableDropinConst);
        }
        else if (arg.value.kind === "EnumValue") {
            argsObj[arg.name.value] = new json_to_graphql_query_1.EnumType(arg.value.value);
        }
        else if (arg.value.kind === "IntValue") {
            argsObj[arg.name.value] = parseInt(arg.value.value);
        }
        else if (arg.value.kind === "FloatValue") {
            argsObj[arg.name.value] = parseFloat(arg.value.value);
        }
        else if (arg.value.kind === "ListValue") {
            var values = flatMap(arg.value.values, function (element) { return element.value; });
            argsObj[arg.name.value] = values;
        }
        else {
            argsObj[arg.name.value] = arg.value.value;
        }
    });
    return argsObj;
};
var getSelections = function (selections) {
    var selObj = {};
    var inlineFragments = [];
    selections.forEach(function (selection) {
        if (selection.kind === "InlineFragment") {
            // Handle inline fragments
            var typeName = selection.typeCondition.name.value;
            var fragmentSelections = getSelections(selection.selectionSet.selections);
            inlineFragments.push(__assign({ __typeName: typeName }, fragmentSelections));
        }
        else {
            // Handle regular fields
            var selectionHasAlias = selection.alias;
            var selectionName = selectionHasAlias
                ? selection.alias.value
                : selection.name.value;
            if (selection.selectionSet) {
                selObj[selectionName] = getSelections(selection.selectionSet.selections);
                if (selectionHasAlias) {
                    selObj[selection.alias.value].__aliasFor =
                        selection.name.value;
                }
            }
            if (selection.arguments && selection.arguments.length > 0) {
                if (!selObj[selectionName]) {
                    selObj[selectionName] = {};
                }
                selObj[selectionName].__args = getArguments(selection.arguments);
            }
            if (!selection.selectionSet &&
                (!selection.arguments || selection.arguments.length === 0)) {
                if (selectionHasAlias) {
                    selObj[selectionName] = { __aliasFor: selection.name.value };
                }
                else {
                    selObj[selectionName] = true;
                }
            }
        }
    });
    // Add inline fragments to the result
    if (inlineFragments.length > 0) {
        if (inlineFragments.length === 1) {
            selObj.__on = inlineFragments[0];
        }
        else {
            selObj.__on = inlineFragments;
        }
    }
    return selObj;
};
var checkEachVariableInQueryIsDefined = function (defintion, variables) {
    var varsList = defintion.variableDefinitions.reduce(function (prev, curr) {
        return __spreadArray(__spreadArray([], prev, true), [
            {
                key: curr.variable.name.value,
                value: undefinedVariableConst,
            },
        ], false);
    }, []);
    Object.entries(variables).forEach(function (_a) {
        var variableKey = _a[0], variableValue = _a[1];
        var idx = varsList.findIndex(function (element) {
            return element.key === variableKey;
        });
        if (idx !== -1) {
            varsList[idx].value = variableValue;
        }
    });
    var undefinedVariable = varsList.find(function (varInQuery) {
        return varInQuery.value === undefinedVariableConst;
    });
    if (undefinedVariable) {
        throw new Error("The query you want to parse is using variables. This means that you have to supply for every variable that is used in the query a corresponding value. You can parse these values as a second parameter on the options object, on the \"variables\" key.");
    }
    return varsList;
};
var replaceVariables = function (obj, variables) {
    return mapValues(obj, function (value) {
        if (isString(value) &&
            new RegExp("".concat(isVariableDropinConst, "$")).test(value)) {
            var variableName = value.replace(isVariableDropinConst, "");
            return variables[variableName];
        }
        else if (isObject(value) && !Array.isArray(value)) {
            return replaceVariables(value, variables);
        }
        else {
            return value;
        }
    });
};
var graphQlQueryToJson = function (query, options) {
    if (options === void 0) { options = {
        variables: {},
    }; }
    var jsonObject = {};
    var parsedQuery = (0, graphql_1.parse)(query);
    if (parsedQuery.definitions.length > 1) {
        throw new Error("The parsed query has more than one set of definitions");
    }
    // @ts-ignore
    var firstDefinition = parsedQuery.definitions[0];
    var operation = firstDefinition.operation;
    checkEachVariableInQueryIsDefined(firstDefinition, options.variables);
    var selections = getSelections(firstDefinition.selectionSet.selections);
    jsonObject[operation] = selections;
    var varsReplacedWithValues = replaceVariables(jsonObject, options.variables);
    return varsReplacedWithValues;
};
exports.graphQlQueryToJson = graphQlQueryToJson;
//# sourceMappingURL=index.js.map